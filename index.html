<!doctype html>
<html>
<head>
    <meta charset="utf-8"></meta>
    <title>django-startup-template</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
</head>
<body>
<div class="wrapper">
    <header>
        <h1>Django Startup Template</h1>
        <p>Instructions on how to set-up a new Django 1.5.1 project on a Webfaction server.</p>
        <form id="data">
            <h2>Project Settings</h2>
            <p><input type="text" placeholder="Project Name" title="Project Name" data-bind="project-name"></p>
            <p><input type="text" placeholder="Webfaction Username" title="Webfaction Username" data-bind="webfaction-username"></p>
            <p><input type="text" placeholder="Webfaction Machine IP Address" title="Webfaction Machine IP Address" data-bind="webfaction-ip"></p>
        </form>

        <h2>Features</h2>
        <ol>
            <li>Super easy deployments with Git.</li>
            <li>Static files hosting on AWS S3</a> (via django-storage).</li>
            <li>Javascript &amp; CSS compression (via django-compress).</li>
            <li>Local Django debugging (via django-debug-toolbar).</li>
            <li>Database schema migrations (via south).</li>
        </ol>

        <h2>Requirements</h2>
        <ol>
            <li>An account on <a href="http://www.webfaction.com?affiliate=rudasn" target="webfaction">Webfaction</a> <small>(<a href="http://www.webfaction.com" target="webfaction">Non-affiliate link</a>)</small>.</li>
            <li>An account on <a href="http://aws.amazon.com/" target="aws">Amazon Web Services (AWS)</a> with S3 enabled.</li>
            <li><a href="http://git-scm.com/" target="_blank">Git</a> - version control and easy deployments.</li>
            <li><a href="https://pypi.python.org/pypi/pip/" target="_blank">Pip</a> - a python package manager</li>
            <li><a href="https://pypi.python.org/pypi/virtualenv/" target="_blank">virtualenv</a> - python virtual environments</li>
            <li><a href="https://pypi.python.org/pypi/virtualenvwrapper" target="_blank">virtualenvwrapper</a> - python virtual environments made easier</li>
        </ol>

        <h2>Contents</h2>
        <ol id="toc"></ol>
    </header>

    <hr>

    <section class="instructions">
        <h2>Install</h2>
        <div class="step">
            <p>Create a new folder on your system and switch to that folder.</p>
<pre class="local">
    <code>mkdir <em class="project-name"></em> &amp;&amp; cd <em class="project-name"></em></code></pre>
        </div>
        <div class="step">
            <p>Create and initialize a new virtual environment.</p>
<pre class="local">
    <code>source /usr/local/bin/virtualenvwrapper.sh</code>
    <code>mkvirtualenv env_<em class="project-name"></em></code>
    <code>workon env_<em class="project-name"></em></code></pre>
        </div>
        <div class="step">
            <p>Download and install the latest stable version of Django (1.5.1).</p>
<pre class="local">
    <code>pip install django</code></pre>
        </div>
        <div class="step">
            <p>Create a new Django project based on this repo in a new <em class="project-name"></em> folder.</p>
<pre class="local">
    <code>django-admin.py startproject --template=https://github.com/rudasn/django-startup-template/zipball/master --extension=py,md,conf,.gitignore <em class="project-name"></em></code>
    <code>cd <em class="project-name"></em></code></pre>
        </div>
        <h2>Initialize</h2>
        <div class="step">
            <p>Make sure you are working from within the virtual environment.</p>
<pre class="local">
    <code>source /usr/local/bin/virtualenvwrapper.sh</code>
    <code>workon env_<em class="project-name"></em></code></pre>
        </div>
        <div class="step">
            <p>Install dependencies.</p>
<pre class="local">
    <code>pip install -r requirements/development.txt</code></pre>
        </div>
        <div class="step">
            <p>Move the local settings file to the right place, so that we know when django is running locally or on the server.</p>
<pre class="local">
    <code>mv <em class="project-name"></em>/is_local.py <em class="project-name"></em>/settings/local.py</code></pre>
        </div>
        <div class="step">
            <p>Test drive</p>
<pre class="local">
    <code>python manage.py syncdb</code>
    <code>python manage.py runserver</code></pre>
            <p>If all goes well you should be able to go to <a href="http://127.0.0.1:8000/" target="local">http://127.0.0.1:8000/</a> and see "Hello World!".</p>
        </div>
        <h2>Set-up</h2>
        <h3>Server</h3>
        <p>Now that we have a new Django project created locally we can go on and set-up the webfaction server that will host our project.</p>
        <div class="step">
            <p>SSH to your webfaction account.</p>
<pre class="remote">
    <code>ssh <em class="webfaction-username"></em>@<em class="webfaction-ip"></em></code></pre>
        </div>
        <div class="step">
            <p>Create a new folder to place your app. It is adviced to keep your code under app as that folder is referenced in other places as well.</p>
<pre class="remote">
    <code>mkdir ~/webapps/<em class="project-name"></em>/app</code></pre>
            <p>The myproject folder created by webfaction will not be used so remove it.</p>
<pre class="remote">
    <code>rm -r ~/webapps/<em class="project-name"></em>/myproject</code></pre>
        </div>
        <div class="step">
            <p>Make sure we work with Python 2.7.</p>
            <p>Add some aliases on .bash_profile to reference python2.7 instead of an older version and reload the file.</p>
<pre class="remote">
    <code>echo "alias python=python2.7" >> ~/.bash_profile
    echo "alias pip=pip-2.7" >> ~/.bash_profile
    echo "alias easy_install=easy_install-2.7" >> ~/.bash_profile
    mkdir ~/lib/python2.7
    source ~/.bash_profile</code></pre>
        </div>
        <div class="step">
            <p>Install Pip.</p>
<pre class="remote">
    <code>easy_install pip</code></pre>
        </div>
        <div class="step">
            <p>Install virtualenv &amp; virtualenvwrapper.</p>
<pre class="remote">
    <code>pip install virtualenv
    pip install --install-option="--user" virtualenvwrapper</code></pre>
        </div>
        <div class="step">
            <p>Set Environment Variables.</p>
<pre class="remote">
    <code>echo "PYTHONPATH=~/lib/python2.7" >> ~/.bash_profile
    echo "export PYTHONPATH" >> ~/.bash_profile
    echo "export VIRTUALENVWRAPPER_PYTHON=/usr/local/bin/python2.7" >> ~/.bash_profile
    echo "export WORKON_HOME=~/.virtualenvs" >> ~/.bash_profile
    echo "export PROJECT_HOME=~/webapps" >> ~/.bash_profile
    echo "export PIP_VIRTUALENV_BASE=$WORKON_HOME" >> ~/.bash_profile
    echo "export PIP_RESPECT_VIRTUALENV=true" >> ~/.bash_profile
    echo "export VIRTUALENVWRAPPER_VIRTUALENV_ARGS='--no-site-packages'"  >> ~/.bash_profile
    echo "if [ -f ~/bin/virtualenvwrapper.sh ]; then" >> ~/.bash_profile
    echo "    source ~/bin/virtualenvwrapper.sh" >> ~/.bash_profile
    echo "fi" >> ~/.bash_profile</code></pre>
        </div>
        <div class="step">
            <p>Create a new virtual environment on the server.</p>
<pre class="remote">
    <code>source ~/bin/virtualenvwrapper.sh
    mkvirtualenv env_<em class="project-name"></em>
    workon env_<em class="project-name"></em></code></pre>
        </div>
        <h3>Application</h3>
        <div class="step">
            <p>Create a new Django application on webfaction called <em class="project-name"></em>.</p>
            <div class="remote">
                <p>Go to the <a href="https://my.webfaction.com/new-application" target="webfaction">New Application</a> page.</p>
                <p><strong>Name</strong> should be <em class="project-name"></em>.</p>
                <p><strong>App Category</strong> should be <em>Django</em>.</p>
                <p><strong>App Type</strong> should be <em>Django 1.5.1</em>.</p>
                <p>Click <strong>Save</strong></p>
                <p>Once the application is created look for its <strong>Port</strong> and type it here <input type="text" placeholder="Port" title="Port" data-bind="webfaction-port">.</p>
            </div>
        </div>
        <div class="step">
            <h3>Git</h3>
            <p>Set-up Git.</p>
            <div class="remote">
                <p>Go to the <a href="https://my.webfaction.com/new-application" target="webfaction">New Application</a> page.</p>
                <p><strong>Name</strong> should be <em>git</em>.</p>
                <p><strong>App Category</strong> should be <em>Git</em>.</p>
                <p><strong>App Type</strong> should be <em>Git 1.7.4.1</em>.</p>
                <p>Click <strong>Save</strong></p>
            </div>
            <p>Then create a new git repo and set up a post-receive hook so that whenever you push to that repo the code is checked out under ~/webapps/<em class="project-name"></em>/app and is ready to start serving.</p>
<pre class="remote">
    <code>GIT_REPO=$HOME'/webapps/git/repos/<em class="project-name"></em>.git'
    git init --bare $GIT_REPO
    touch $GIT_REPO/hooks/post-receive
    echo "#!/bin/sh" >> $GIT_REPO/hooks/post-receive
    echo "echo 'Executing post-receive'" >> $GIT_REPO/hooks/post-receive
    echo "APP_DIR=$HOME/webapps/<em class="project-name"></em>" >> $GIT_REPO/hooks/post-receive
    echo "GIT_WORK_TREE=\$APP_DIR/app git checkout -f" >> $GIT_REPO/hooks/post-receive
    echo "GIT_WORK_TREE=\$APP_DIR/app git reset --hard" >> $GIT_REPO/hooks/post-receive
    echo "rm \$APP_DIR/app/<em class="project-name"></em>/settings/development.py" >> $GIT_REPO/hooks/post-receive
    chmod +x $GIT_REPO/hooks/post-receive
    rm -r $HOME/webapps/git/repos/proj.git</code></pre>
            <p>If you want to auto compress and move the static files to Amazon S3 on every push (not advised) also do the following:</p>
<pre class="remote">
    <code>echo "source $HOME/bin/virtualenvwrapper.sh" >> $GIT_REPO/hooks/post-receive
    echo "workon env_<em class="project-name"></em>" >> $GIT_REPO/hooks/post-receive
    echo "python $APP_DIR/app/manage.py compress" >> $GIT_REPO/hooks/post-receive
    echo "python $APP_DIR/app/manage.py collectstatic  --noinput" >> $GIT_REPO/hooks/post-receive
    echo "deactivate" >> $GIT_REPO/hooks/post-receive</code></pre>
        </div>
        <div class="step">
            <h3>Database</h3>
            <p>Create and set-up the Database.</p>
            <div class="remote">
                <p>Go to the <a href="https://my.webfaction.com/new-database" target="webfaction">New Database</a> page.</p>
                <p><strong>Name</strong> should be <em><em class="project-name"></em></em>.</p>
                <p><strong>Database type</strong> should be <em>PostgreSQL</em>.</p>
                <p>Create a new <strong>Database Owner</strong>.</p>
                <p><strong>Username</strong> should be <em class="project-name"></em>.</p>
                <p><strong>Password</strong> should be something difficult like <input type="text" placeholder="Password" title="Database Password" data-bind="random-password">
                    <br><small>(This was randomly generated. <a id="generate-password" href="">Generate another one</a>.)</small></p>
                <p>Click <strong>Save</strong></p>
            </div>
            <div class="local">
                <p>Open the <code>settings/production.py</code> file and change the <code>DATABASE</code> entry with your database credentials to look like this:</p>
<pre>
    <code>DATABASE = {
        'NAME': '<em class="project-name"></em>',
        'USER': '<em class="project-name"></em>',
        'PASSWORD': '<em class="random-password"></em>'
    }</code></pre>
            </div>
        </div>
        <div class="step">
            <h3>Amazon Web Services S3</h3>
            <p>Create AWS S3 bucket and provide your security credentials.</p>
            <div class="remote">
                <p>Go to your <a href="https://console.aws.amazon.com/s3/home" target="aws">AWS S3 console</a>.</p>
                <p>Click on <strong>Create Bucket</strong>.</p>
                <p><strong>Bucket Name</strong> can be <input type="text" class="project-name" placeholder="AWS S3 Bucket Name" title="AWS S3 Bucket Name" data-suffix="_aws_static" data-bind="aws-bucket">.</p>
                <p>Once the bucket is created select it from the list and click on <strong>Properties</strong>.</p>
                <p>Create a new <strong>Permissions</strong> entry allowing <em>Everyone</em> to just have <em>View Permissions</em>.</p>
            </div>
            <p></p>
            <div class="remote">
                <p>Go to <a href="https://console.aws.amazon.com/iam/home?#users" target="aws">AWS Identity and Access Management</a> page.</p>
                <p><strong>Create</strong> a new user named <em class="project-name"></em>. Make sure the option to "<em>Generate an access key for each User</em>" is checked.</p>
                <p>Once the user is created click on "<em>Show User Security Credentials</em>" and copy &amp; paste them here.</p>
                <p><input type="text" placeholder="AWS S3 User Key" title="AWS S3 User Key" data-bind="aws-key"></p>
            <p><input type="text" placeholder="AWS S3 User Secret" title="AWS S3 User Secret" data-bind="aws-secret"></p>
            </div>
            <div class="local">
                <p>Open the <code>settings/production.py</code> file and change the <code>AMAZONS3</code> entry to look like this:</p>
<pre>
    <code>AMAZONS3 = {
        'ACCESS_KEY_ID': '<em class="aws-key"></em>',
        'SECRET_ACCESS_KEY': '<em class="aws-secret"></em>',
        'BUCKET': '<em class="aws-bucket"></em>'
    }</code></pre>
            </div>
            <p>Assign permissions to the user you just created to manage the project's bucket.</p>

            <div class="remote">
                <p>Go back to the <a href="https://console.aws.amazon.com/iam/home?#users" target="aws">AWS Identity and Access Management</a> page.</p>
                <p>Select the <em class="project-name"></em> user.</p>
                <p>Click on <em>Permissions</em> (on the tabs at the bottom of the page).</p>
                <p>Click on <em>Attach User Policy</em> and select <em>Custom Policy</em>.</p>
                <p><strong>Policy Name</strong> can be something like <em>S3FullPermissions</em><em class="project-name"></em><em class="aws-bucket"></em></p>
                <p><strong>Policy Document</strong> should be:</p>
<pre>
    <code>{
    "Version": "2012-10-17",
        "Statement": [{
            "Effect": "Allow",
            "Action": ["s3:*"],
            "Resource": ["arn:aws:s3:::<em class="aws-bucket"></em>/*"]
        }]
    }</code></pre>
                <p>This grants full access to the <em class="project-name"></em> user <strong>just</strong> on the <em class="aws-bucket"></em> bucket.</p>
            </div>
        </div>
        <div class="step">
            <p>Change your apache config file to match your project settings.</p>
<pre class="local">
    <code>sed 's/__/<em class="webfaction-username"></em>/g' webfaction/apache.conf > webfaction/apache2.conf
    sed 's/00000/<em class="webfaction-port"></em>/g' webfaction/apache2.conf > webfaction/httpd.conf
    rm webfaction/apache.conf</code></pre>
        </div>
        <div class="step">
            <p>Create a new local repo for our project.</p>
<pre class="local">
    <code>git init
    git add <em class="project-name"></em> requirements webfaction .gitignore manage.py README.md SETUP.md requirements.txt wsgi.py
    git commit -am 'Initial commit'</code></pre>
            <p>Add the remote git repo we created earlier. Call it <strong>wf</strong>.</p>
<pre class="local">
    <code>git remote add wf ssh://<em class="webfaction-username"></em>@<em class="webfaction-username"></em>.webfactional.com/~/webapps/git/repos/<em class="project-name"></em>.git</code></pre>
            <p>Push our code to our remote.</p>
<pre class="local">
    <code>git push wf master</code></pre>
        </div>
        <div class="step">
            <p>Move the apache configuration file to the appropriate place.</p>
<pre class="remote">
    <code>mv ~/webapps/<em class="project-name"></em>/app/webfaction/httpd.conf ~/webapps/<em class="project-name"></em>/apache2/conf</code></pre>
            <p>We no longer need the <code>webfaction</code> folder so remove it.</p>
<pre class="local">
    <code>rm -r <em class="project-name"></em>/app/webfaction
    git commit -am 'Remove webfaction folder'
    git push wf master</code></pre>
        </div>
        <div class="step">
            <p>Install requirements.</p>
<pre class="remote">
    <code>cd ~/webapps/<em class="project-name"></em>/app
    pip install -r requirements.txt</code></pre>
        </div>
        <div class="step">
            <p>Initialize the database.</p>
<pre class="remote">
    <code>cd ~/webapps/<em class="project-name"></em>/app
    python manage.py syncdb</code></pre>
            <p>You will be asked to create an admin user. Go ahead and do that.</p>
        </div>
        <div class="step">
            <p>Compress our JS &amp; CSS:</p>
<pre class="remote">
    <code>python manage.py compress</code></pre>
            <p>You will be asked to create an admin user. Go ahead and do that.</p>
        </div>
        <div class="step">
            <p>Push our local static files on AWS.</p>
<pre class="remote">
    <code>python manage.py collectstatic --noinput</code></pre>
            <p>You will be asked to create an admin user. Go ahead and do that.</p>
        </div>
        <div class="step">
            <p>Restart the web server.</p>
<pre class="remote">
    <code>~/webapps/<em class="project-name"></em>/apache2/bin/restart</code></pre>
            <p>If it says that the web server is not running then start it.</p>
<pre class="remote">
    <code>~/webapps/<em class="project-name"></em>/apache2/bin/start</code></pre>
        </div>
        <div class="step">
            <p>Create a Website on Webfaction.</p>
            <div class="remote">
                <p>Go to the <a href="https://my.webfaction.com/new-website" target="webfaction">New Website</a> page.</p>
                <p>Create a new <strong>Domain</strong>. <em class="project-name"></em>.<em class="webfaction-username"></em><em>.webfactional.com</em> should work just fine.</p>
                <p>For <strong>Contents</strong> choose <em>Reuse an existing application</em> and select <em class="project-name"></em> from the list.</p>
                <p>Click <strong>Save</strong>.</p>
            </div>
        </div>
    </section>

    <script type="text/javascript">
        var inputs = $('input[data-bind]').on('change', function(e) {
            var $this = $(this),
                val = $this.val(), //.trim().replace(/\s+/g,'_'),
                group = $this.attr('data-bind'),
                siblings = inputs.filter('[data-bind="' + group + '"]'),
                fields = $this.data('inputs') ||
                    $this.data('inputs', $('.' + $this.attr('data-bind'))) &&
                    $this.data('inputs');

            fields.each(function(i, field) {
                var $this = $(this),
                    suffix = $this.attr('data-suffix') || '',
                    prefix = $this.attr('data-prefix') || '',
                    value = prefix + val + suffix,
                    method = this.tagName === 'INPUT' ? 'val' : 'text';

                $this[method](value);
            });

            siblings.add(this); //.val(val);

            console.log('change', val, fields);
        });

        var toc = $('#toc'),
            headings = $('h2, h3, h4','.instructions');

        headings.each(function(i, el) {
            var $this = $(this).attr('id', 'heading-' + i ).attr('data-index', i),
                title = $this.text(),
                level = parseInt(this.tagName.replace(/^H/, ''), 10) - 2,
                parent = level ?
                    headings.slice(0, i).filter('h' + (level + 1) + ':last') :
                    null,
                entry = $('<li id="at-heading-' + i +'"></li>')
                    .append('<a href="#heading-' + i + '">' + title + '</a>'),
                parent_entry = parent ?
                    $('#at-heading-' + parent.attr('data-index')) :
                    null,
                appendTo = parent_entry ?
                    $('ol', parent_entry).length ?
                        $('ol', parent_entry) :
                        $('<ol></ol>').appendTo(parent_entry)
                     :
                    toc;

            entry.appendTo(appendTo);
        });

        $('#generate-password').click(function(e) {
            e.preventDefault();
            e.stopPropagation();
            inputs
                .filter('[data-bind="random-password"]')
                    .val(generatePassword())
                    .trigger('change');
        }).click();

        function generatePassword() {
            // http://stackoverflow.com/a/1497512/67903
            var length = 12,
                charset = "abcdefghijklnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789=+-_)(^%$£@!",
                retVal = "";
            for (var i = 0, n = charset.length; i < length; ++i) {
                retVal += charset.charAt(Math.floor(Math.random() * n));
            }
            return retVal;
        }
    </script>
</div>
</body>
</html>
